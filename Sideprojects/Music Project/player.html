<!DOCTYPE html>
<html>
  <body>
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <button onclick="restart()">Restart</button>
    <button onclick="togglePlayState()">play/pause</button>
    <button onclick="skip()">Skip</button>
    <progress style="width:600px" id="progressBar" value="0" max="100"></progress>

    
    <div id="np"></div>
    
    <div id="player"></div>
    
    <p id="sugg"></p>
    

    <script>
    

    
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '390',
          width: '640',
          //disablekeyboard, no controls
          playerVars: { 'disablekb': 1, 'controls': 0, 'iv_load_policy': 3 },
          events: {
            'onReady': enable, //player exists
            'onStateChange': stateHandler //handle all states
          }
        });
      }

      //cue the songs if the player exists
      function enable(event) {
        //enable gui
        //start the program
        //enable the progress bar
        var progressBar = setInterval(function(){
            document.getElementById('progressBar').value = getScrollBarProgress();
        }, 10);
      }
      
      //Handle the states
      function stateHandler(event){
        //log the title of the song + play handling
        if(event.data == 1){
            console.log(player.getVideoData().title);
            document.getElementById("np").innerHTML = player.getVideoData().title;
            //handle play
        }
        
        //handle pause
        if(event.data == 2){
            //handle pause
        }
        
        //play the next song when end
        if(event.data == 0){
            generateNext();
        }
      }
      
      var standard; //init standard queue
      var prior = []; //init prior queue
      
      //Start with a playlist from a user
      function startOnPlaylist(reference){
        standard = ['Pww31vN_1QY','QglaLzo_aPk','xshEZzpS4CQ','p7ZsBPK656s','ZRnrjxDKv6Q','lEHM9HZf0IA']; //the playlist NCS
        generateNext();
      }
      
      //start with a certain track, the rest of the queue is random
      function startOnTrack(track){
        standard = ['tte5ve6IpKc','oqh3FuZ1c5o','LpLr2YptJGo','IG3ZmJKm8aM']; //random NIGHTCORE
        standard.unshift(track);
        generateNext();
      }
      
      
       
      //generate the next song
      function generateNext(){
        if(!(prior && prior.length)){
            if(standard && standard.length){
                console.log("loading from standard: " + standard[0]);
                player.loadVideoById(standard[0]);
                standard.shift();
                generateSuggestions();
            }else{
                console.log("standard is empty");
                player.stopVideo();
            }
        }else{
            console.log("loading from prior: " + prior[0]);
            player.loadVideoById(prior[0]);
            prior.shift();
        }
      }
      
      //adds a song to the prior
      function addPrior(id){
        prior.push(id);
      }
      
      
      //suggestions = array of random standards
      var suggestions;
      //generate a table of suggestions from standard
      function generateSuggestions(){
        //suggestions
        console.log(standard);
        suggestions = standard.slice();
        //suggestions.shuffle();
        shuffleArray(suggestions);
        console.log(standard);
        suggestions = suggestions.slice(0,4);
        document.getElementById("sugg").innerHTML = "";

        var i=0, j=suggestions.length;
        var iv = setInterval(function() {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.open("GET", "https://api.etherealtri.be/keyid/?"+suggestions[i], false);
            xmlhttp.send();
            document.getElementById("sugg").innerHTML += '<div style="position: relative;" onclick="suggestion(\'' + suggestions[i] + '\')"><p style="position: absolute; top: 0px; left: 10px; color:white; margin-top: 5px;">' + JSON.parse(xmlhttp.responseText).title + '</p><img width="300px" src="' + JSON.parse(xmlhttp.responseText).thumb + '"/></div>';
            if (++i>=j) clearInterval(iv);
        }, 1);
        
      }
      
      
      
      //moves from standard to prior
      function suggestion(id){
        addPrior(id);
        removeStandard(id);
        generateSuggestions();
      }
      
      //remove an element from standard
      function removeStandard(id){
        var index = standard.indexOf(id);
        if (index > -1) {
          standard.splice(index, 1);
        }
      }
      
      
      
    function shuffleArray(array) {
        for (var i = array.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = array[i];
            array[i] = array[j];
            array[j] = temp;
        }
    }
      
      
      
      
      /*#################################*/
      /*#THESE ARE THE PLAYER CONTROL FUNCTIONS#*/
      /*################################*/
      
      //lower the volume, volume range 0-100, down=amount
      function lowerVolume(down){
        var cur = player.getVolume();
        var newv = cur-down;
        if(newv<0){
            newv = 0;
        }
        player.setVolume(newv);
      }
      
      //raise the volume, volume range 0-100, up=amount
      function raiseVolume(up){
        var cur = player.getVolume();
        var newv = cur+up;
        if(newv>100){
            newv = 100;
        }
        player.setVolume(newv);
      }
      
      //set the volume in absolute numbers 0-100
      function setVolume(vol){
        if(vol > 100){
            vol = 100;
        }
        if(vol < 0){
            vol = 0;
        }
        player.setVolume(vol);
      }
      
      //skip to the next song
      function skip(){
        generateNext();
      }
      
      //get the percentage of the song that has passed
      function getScrollBarProgress(){
          var perc = player.getCurrentTime()/player.getDuration()*100;
          if(perc >= 0){
              return perc;
          }
        return 0;
      }
      
      //seek to the percentage of the song
      function seek(perc){
        player.seekTo(player.getDuration()/100*perc);
      }
      
      //pause
      function pause(){
        player.pauseVideo();
      }
      
      //play again after pause
      function play(){
        player.playVideo();
      }
      
      //get the playstate, returns "playing", "paused" or any other playstatenumber
      function getPlayState(){
        var state = player.getPlayerState();
        if(state == 1){
            return "playing";
        }
        if(state == 2){
            return "paused";
        }
        return state;
      }
      
      //toggle play state
      function togglePlayState(){
          if(getPlayState() == "playing"){
              pause();
          }
          if(getPlayState() == "paused"){
              play();
          }
      }
      
      //restart the current song
      function restart(){
          seek(0);
      }
      
      
      
      //this is the documentation
    var documentation = `
    You have the possibility to administrate some funtions, they are listed below
    
    [VOLUME]
        * lowerVolume(down): lower the volume, volume range 0-100, down=amount
        * raiseVolume(up): raise the volume, volume range 0-100, up=amount
        * setVolume(vol): set the volume in absolute numbers 0-100
    
    [SONG MANAGEMENT]
        * skip(): skip to the next song
    
    [SCROLLBAR + SEEK]
        * getScrollBarProgress(): get the percentage of the song that has passed
        * seek(perc): seek to the percentage of the song
        * restart(): restart the current song
        
    [PLAYSTATE]
        * pause(): pause
        * play(): play again after pause
        * getPlayState(): get the playstate, returns "playing", "paused" or any other playstatenumber
        * togglePlayState(): toggle play state
        
    [QUEUES]
        * startOnPlaylist(reference): Start with a playlist from a user
        * startOnTrack(track): start with a certain track, the rest of the queue is random
        * suggestion(id): moves from standard to prior
        
    [QUEUES EXTENDED]
        * addPrior(id): adds a song to the prior
        * removeStandard(id): remove an element from standard
    `;
    
    //log the documentation to the console
    console.log(documentation);
    
    
    //window.onload = function(){startOnPlaylist("d")};
    
    document.getElementById('progressBar').addEventListener('click', function (e) {
        var x = e.pageX - this.offsetLeft;
        var xconvert = x/6; //cause width is 600px and you need a value in [0,100] range
        seek(xconvert);
    });
    
    </script>
  </body>
</html>
